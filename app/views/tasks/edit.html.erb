<div class="flex flex-col items-center py-10 bg-custom-white rounded-lg min-h-screen">
  <div class="card bg-custom-white shadow-xl max-w-2xl w-full border border-custom-light-gray/50">
    <div class="card-body">      
      <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <%= render 'shared/error_messages', object: @task %>

      <%= form_with model: @task, local: true, html: { class: "flex flex-col gap-6" } do |f| %>
        <!-- ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
        <div class="form-control">
          <%= f.label :title, class: "label text-custom-dark-green font-medium" %>
          <div class="join w-full">
            <%= f.text_field :title, class: "input input-bordered join-item flex-1 bg-custom-white border-custom-dark-green text-custom-dark-green focus:border-custom-dark-green focus:ring-2 focus:ring-custom-dark-green/20 focus:outline-none" %>
            <!-- â™»ï¸onclickã‚¤ãƒ™ãƒ³ãƒˆã¯æ”¹å–„ã®ä½™åœ°ã‚ã‚Šã€‚ä»Šå¾ŒStimulusã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§å®Ÿè£…äºˆå®š -->
            <button type="button" 
                    class="btn btn-square join-item bg-custom-dark-green hover:bg-custom-dark-green/80 text-custom-white border-none"
                    onclick="document.getElementById('task_title').value = ''">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5">
                <path d="M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z" />
              </svg>
            </button>
          </div>
        </div>

        <!-- ã‚¿ã‚°é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-control">
          <%= f.label :tag_ids, class: "label text-custom-dark-green font-medium" %>
          <!-- ã‚¿ã‚°é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
          <div class="dropdown">
            <!-- â™»ï¸safariãƒ–ãƒ©ã‚¦ã‚¶å«ã‚€ã™ã¹ã¦ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã€‚https://v4.daisyui.com/components/dropdown/#method-2-using-css-focus -->
            <div tabindex="0" role="button" class="btn btn-outline w-full bg-custom-white border-custom-dark-green text-custom-dark-green hover:bg-custom-dark-green hover:text-custom-white">
              <span>é¸æŠ</span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                <path fill-rule="evenodd" d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
              </svg>
            </div>

            <!-- âš ï¸buttonã‚¿ã‚°ã‚’ä½¿ç”¨ã—ãŸå ´åˆã€safariãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚https://v4.daisyui.com/components/dropdown/#method-2-using-css-focus-->
            <!-- <button type="button" class="btn btn-outline w-full bg-custom-white border-custom-dark-green text-custom-dark-green hover:bg-custom-dark-green hover:text-custom-white">
              <span>é¸æŠ</span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                <path fill-rule="evenodd" d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
              </svg>
            </button>
            -->

            <!-- ğŸ“tabindex="0"ã«ã‚ˆã‚Šã€ãƒ©ãƒ™ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ç”»é¢ãŒé–‰ã˜ãªããªã‚‹ã€‚-->
            <ul tabindex="0" class="dropdown-content bg-custom-white rounded-box z-[1] p-2 shadow w-full max-h-60 overflow-y-auto border border-custom-light-gray/50">
              <% Tag.all.each do |tag| %>
                <li class="rounded p-1">
                  <label class="flex items-center gap-2 text-custom-dark-green hover:bg-custom-light-gray hover:text-custom-dark-green rounded cursor-pointer p-1 transition-colors duration-200">
                    <input type="checkbox" 
                            name="task[tag_ids][]" 
                            value="<%= tag.id %>"
                            <%= 'checked' if @task.tag_ids.include?(tag.id) %>
                            class="checkbox bg-custom-white border-custom-dark-green"
                            style="--chkbg: #233D31; --chkfg: #FCFCF9;">
                    <span><%= tag.name %></span>
                  </label>
                </li>
              <% end %>
            </ul>
          </div>
        </div>

        <!-- â™»ï¸ã‚¿ã‚°æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ å°†æ¥çš„ã«ä»¥ä¸‹ã®å®Ÿè£…ã§è¡Œã„ãŸã„ãŒã€jsãŒã¾ã ç†è§£ä¸è¶³ãªã®ã§ç½®ã„ã¦ãŠã-->
        <%#= render partial: "tag_search_form", locals: { f: f, task: @task } %>

        <!-- ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰ -->
        <div class="form-control">
          <div class="flex items-center justify-between mb-3">
            <!-- â™»ï¸ã“ã“ã¯f.labelã«å¤‰æ›´äºˆå®š -->
            <%= f.label :todos, class: "label text-custom-dark-green font-medium" %>
            <button type="button" id="add-todo-btn" class="btn btn-ghost btn-sm bg-custom-dark-green hover:bg-custom-dark-green/80 text-custom-white border-none" onclick="addTodoField()">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                <path d="M8.75 3.75a.75.75 0 0 0-1.5 0v3.5h-3.5a.75.75 0 0 0 0 1.5h3.5v3.5a.75.75 0 0 0 1.5 0v-3.5h3.5a.75.75 0 0 0 0-1.5h-3.5v-3.5Z" />
              </svg>
              <span>è¿½åŠ </span>
            </button>
          </div>

          <!-- Todoãƒªã‚¹ãƒˆã®è¡¨ç¤ºãƒ»ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
          <div id="todos-container" class="space-y-2">
            <%= f.fields_for :todos do |todo_form| %>
              <div class="flex items-center gap-2">                
                <!-- å‰Šé™¤ãƒœã‚¿ãƒ³ -->
                <button type="button" 
                        class="btn btn-circle btn-outline btn-sm border-custom-dark-green text-custom-dark-green hover:bg-custom-dark-green hover:text-custom-white bg-transparent"
                        onclick="removeTodoField(this)">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                    <path d="M5.28 4.22a.75.75 0 0 0-1.06 1.06L6.94 8l-2.72 2.72a.75.75 0 1 0 1.06 1.06L8 9.06l2.72 2.72a.75.75 0 1 0 1.06-1.06L9.06 8l2.72-2.72a.75.75 0 0 0-1.06-1.06L8 6.94 5.28 4.22Z" />
                  </svg>
                </button>
                <!-- todoå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                <%= todo_form.text_field :body, 
                    placeholder: "ã‚„ã‚‹ã“ã¨ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", 
                    class: "input input-bordered flex-1 bg-custom-white border-custom-dark-green text-custom-dark-green focus:border-custom-dark-green focus:ring-2 focus:ring-custom-dark-green/20 focus:outline-none placeholder:text-custom-dark-green/50" %>
                <%= todo_form.hidden_field :id %>
                <%= todo_form.hidden_field :_destroy, class: "hidden" %>
              </div>
            <% end %>
          </div>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="flex justify-end gap-4 mt-6">
          <%= link_to "æˆ»ã‚‹", task_path(@task), class: "btn btn-outline border-custom-dark-green text-custom-dark-green hover:bg-custom-dark-green hover:text-custom-white bg-transparent" %>
          <%= f.submit "å¤‰æ›´", class: "btn bg-custom-green hover:bg-custom-green/80 text-custom-white border-none" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- â™»ï¸ jsã¯ä»Šå¾Œã™ã¹ã¦Stimulusã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã«ç§»ã™äºˆå®š -->
<script>
// ToDoã®æ•°ã‚’ç›£è¦–ã—ã¦è¿½åŠ ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ¶å¾¡
function updateAddButtonState() {
  const container = document.getElementById('todos-container');
  const addButton = document.getElementById('add-todo-btn');
  
  // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ToDoã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå‰Šé™¤ãƒãƒ¼ã‚¯ã•ã‚ŒãŸã‚‚ã®ã¯é™¤å¤–ï¼‰
  const visibleTodos = Array.from(container.children).filter(todoDiv => {
    const destroyField = todoDiv.querySelector('input[type="hidden"][name$="[_destroy]"]');
    const isDestroyed = destroyField && destroyField.value === '1';
    const isHidden = todoDiv.style.display === 'none';
    
    // å‰Šé™¤ãƒãƒ¼ã‚¯ã•ã‚Œã¦ã„ãªã„ã€ã‹ã¤éè¡¨ç¤ºã§ãªã„ToDoã®ã¿ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    return !isDestroyed && !isHidden;
  });
  
  const todoCount = visibleTodos.length;
  
  if (todoCount >= 3) {
    // 3å€‹ä»¥ä¸Šã®å ´åˆã€ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    addButton.disabled = true;
    addButton.classList.add('opacity-50', 'cursor-not-allowed');
    addButton.classList.remove('hover:bg-custom-dark-green/80');
  } else {
    // 3å€‹æœªæº€ã®å ´åˆã€ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
    addButton.disabled = false;
    addButton.classList.remove('opacity-50', 'cursor-not-allowed');
    addButton.classList.add('hover:bg-custom-dark-green/80');
  }
}

function addTodoField() {
  const container = document.getElementById('todos-container');
  const todoCount = container.children.length; // ğŸ“ todoã®æ•°ã€ã¤ã¾ã‚Šæ–°ã—ã„todoã®indexã‚’å–å¾—
  
  // â™»ï¸ ã“ã®ç®‡æ‰€ã¯ä»Šå¾Œformã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã£ãŸæ›¸ãæ–¹ã«å¤‰æ›´äºˆå®š(CSRFå¯¾ç­–ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãªã©ãŒæ¬²ã—ã„ãŸã‚)
  // æ–¹æ³•ã¨ã—ã¦ã¯ã€<template>ã‚¿ã‚°å†…ã§f.fields_forã‚’ä½¿ã†ã€‚
  const newTodoHtml = `
    <div class="flex items-center gap-2">
      <button type="button" 
              class="btn btn-circle btn-outline btn-sm border-custom-dark-green text-custom-dark-green hover:bg-custom-dark-green hover:text-custom-white bg-transparent"
              onclick="removeTodoField(this)">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
          <path d="M5.28 4.22a.75.75 0 0 0-1.06 1.06L6.94 8l-2.72 2.72a.75.75 0 1 0 1.06 1.06L8 9.06l2.72 2.72a.75.75 0 1 0 1.06-1.06L9.06 8l2.72-2.72a.75.75 0 0 0-1.06-1.06L8 6.94 5.28 4.22Z" />
        </svg>
      </button>
      <input type="hidden" name="task[todos_attributes][${todoCount}][_destroy]" value="0" class="hidden">
      <input type="text" 
              name="task[todos_attributes][${todoCount}][body]" 
              placeholder="ã‚„ã‚‹ã“ã¨ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" 
              class="input input-bordered flex-1 bg-custom-white border-custom-dark-green text-custom-dark-green focus:border-custom-dark-green focus:ring-2 focus:ring-custom-dark-green/20 focus:outline-none placeholder:text-custom-dark-green/50">
      <input type="hidden" name="task[todos_attributes][${todoCount}][id]" value="">
    </div>
  `;
  container.insertAdjacentHTML('beforeend', newTodoHtml); // ğŸ“ 'beforeend'ã«ã‚ˆã‚Šã€</div>ã®ç›´å‰ã«æ–°ã—ã„todoã‚’è¿½åŠ ã™ã‚‹ã€‚
  
  // ToDoè¿½åŠ å¾Œã«ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
  updateAddButtonState();
}

function removeTodoField(button) {
  const todoForm = button.closest('.flex');
  const todoId = todoForm.querySelector('input[type="hidden"][name$="[id]"]').value;
  const todoDestroyField = todoForm.querySelector('input[type="hidden"][name$="[_destroy]"]');

  if (confirm('ã“ã®todoã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    if (todoId) {
      // æ—¢å­˜ã®todoã®å ´åˆã€_destroyãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®šã—ã¦å‰Šé™¤ãƒãƒ¼ã‚¯
      todoDestroyField.value = '1';
      todoForm.style.display = 'none'; // ğŸ“ Railsã§å‰Šé™¤å¯¾è±¡ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«DOMè¦ç´ ã‚’æ®‹ã™å¿…è¦ãŒã‚ã‚‹ã€‚
    } else {
      // æ–°è¦è¿½åŠ ã®todoã®å ´åˆã€ç›´æ¥å‰Šé™¤
      todoForm.remove(); // DOMè¦ç´ ã”ã¨å‰Šé™¤
    }
    
    // ToDoå‰Šé™¤å¾Œã«ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    updateAddButtonState();
  }
}

// åˆæœŸåŒ–é–¢æ•°
function initializeTodoButton() {
  updateAddButtonState();
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', initializeTodoButton);
window.addEventListener('load', initializeTodoButton);

// å³åº§ã«å®Ÿè¡Œã‚’è©¦è¡Œï¼ˆDOMãŒæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
if (document.readyState !== 'loading') {
  initializeTodoButton();
}
</script>
